"use strict";(self.webpackChunkmomraGisCore=self.webpackChunkmomraGisCore||[]).push([[6290],{5992:(e,t,r)=>{r.d(t,{e:()=>o});var i,s,n,a={exports:{}};i=a,s=function(){function e(e,r,s){s=s||2;var n,a,o,u,h,c,v,d=r&&r.length,p=d?r[0]*s:e.length,f=t(e,0,p,s,!0),x=[];if(!f||f.next===f.prev)return x;if(d&&(f=l(e,r,f,s)),e.length>80*s){n=o=e[0],a=u=e[1];for(var y=s;y<p;y+=s)(h=e[y])<n&&(n=h),(c=e[y+1])<a&&(a=c),h>o&&(o=h),c>u&&(u=c);v=0!==(v=Math.max(o-n,u-a))?1/v:0}return i(f,x,s,n,a,v),x}function t(e,t,r,i,s){var n,a;if(s===w(e,t,r,i)>0)for(n=t;n<r;n+=i)a=L(n,e[n],e[n+1],a);else for(n=r-i;n>=t;n-=i)a=L(n,e[n],e[n+1],a);if(a&&S(a,a.next)){var o=a.next;z(a),a=o}return a}function r(e,t){if(!e)return e;t||(t=e);var r,i=e;do{if(r=!1,i.steiner||!S(i,i.next)&&0!==g(i.prev,i,i.next))i=i.next;else{var s=i.prev;if(z(i),(i=t=s)===i.next)break;r=!0}}while(r||i!==t);return t}function i(e,t,l,u,h,c,v){if(e){!v&&c&&d(e,u,h,c);for(var p,f,x=e;e.prev!==e.next;)if(p=e.prev,f=e.next,c?n(e,u,h,c):s(e))t.push(p.i/l),t.push(e.i/l),t.push(f.i/l),z(e),e=f.next,x=f.next;else if((e=f)===x){v?1===v?i(e=a(r(e),t,l),t,l,u,h,c,2):2===v&&o(e,t,l,u,h,c):i(r(e),t,l,u,h,c,1);break}}}function s(e){var t=e.prev,r=e,i=e.next;if(g(t,r,i)>=0)return!1;for(var s=e.next.next;s!==e.prev;){if(x(t.x,t.y,r.x,r.y,i.x,i.y,s.x,s.y)&&g(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function n(e,t,r,i){var s=e.prev,n=e,a=e.next;if(g(s,n,a)>=0)return!1;for(var o=s.x<n.x?s.x<a.x?s.x:a.x:n.x<a.x?n.x:a.x,l=s.y<n.y?s.y<a.y?s.y:a.y:n.y<a.y?n.y:a.y,u=s.x>n.x?s.x>a.x?s.x:a.x:n.x>a.x?n.x:a.x,h=s.y>n.y?s.y>a.y?s.y:a.y:n.y>a.y?n.y:a.y,c=p(o,l,t,r,i),v=p(u,h,t,r,i),d=e.prevZ,f=e.nextZ;d&&d.z>=c&&f&&f.z<=v;){if(d!==e.prev&&d!==e.next&&x(s.x,s.y,n.x,n.y,a.x,a.y,d.x,d.y)&&g(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,f!==e.prev&&f!==e.next&&x(s.x,s.y,n.x,n.y,a.x,a.y,f.x,f.y)&&g(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(;d&&d.z>=c;){if(d!==e.prev&&d!==e.next&&x(s.x,s.y,n.x,n.y,a.x,a.y,d.x,d.y)&&g(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;f&&f.z<=v;){if(f!==e.prev&&f!==e.next&&x(s.x,s.y,n.x,n.y,a.x,a.y,f.x,f.y)&&g(f.prev,f,f.next)>=0)return!1;f=f.nextZ}return!0}function a(e,t,i){var s=e;do{var n=s.prev,a=s.next.next;!S(n,a)&&m(n,s,s.next,a)&&b(n,a)&&b(a,n)&&(t.push(n.i/i),t.push(s.i/i),t.push(a.i/i),z(s),z(s.next),s=e=a),s=s.next}while(s!==e);return r(s)}function o(e,t,s,n,a,o){var l=e;do{for(var u=l.next.next;u!==l.prev;){if(l.i!==u.i&&y(l,u)){var h=M(l,u);return l=r(l,l.next),h=r(h,h.next),i(l,t,s,n,a,o),void i(h,t,s,n,a,o)}u=u.next}l=l.next}while(l!==e)}function l(e,i,s,n){var a,o,l,h=[];for(a=0,o=i.length;a<o;a++)(l=t(e,i[a]*n,a<o-1?i[a+1]*n:e.length,n,!1))===l.next&&(l.steiner=!0),h.push(f(l));for(h.sort(u),a=0;a<h.length;a++)s=r(s=c(h[a],s),s.next);return s}function u(e,t){return e.x-t.x}function h(e){if(e.next.prev===e)return e;let t=e;for(;;){const r=t.next;if(r.prev===t||r===t||r===e)break;t=r}return t}function c(e,t){var i=function(e,t){var r,i=t,s=e.x,n=e.y,a=-1/0;do{if(n<=i.y&&n>=i.next.y&&i.next.y!==i.y){var o=i.x+(n-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=s&&o>a){if(a=o,o===s){if(n===i.y)return i;if(n===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!r)return null;if(s===a)return r;var l,u=r,h=r.x,c=r.y,d=1/0;i=r;do{s>=i.x&&i.x>=h&&s!==i.x&&x(n<c?s:a,n,h,c,n<c?a:s,n,i.x,i.y)&&(l=Math.abs(n-i.y)/(s-i.x),b(i,e)&&(l<d||l===d&&(i.x>r.x||i.x===r.x&&v(r,i)))&&(r=i,d=l)),i=i.next}while(i!==u);return r}(e,t);if(!i)return t;var s=M(i,e),n=r(i,i.next);let a=h(s);return r(a,a.next),n=h(n),h(t===i?n:t)}function v(e,t){return g(e.prev,e,t.prev)<0&&g(t.next,e,e.next)<0}function d(e,t,r,i){var s=e;do{if(null===s.z&&(s.z=p(s.x,s.y,t,r,i)),s.prev.next!==s||s.next.prev!==s)return s.prev.next=s,s.next.prev=s,d(e,t,r,i);s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,function(e){var t,r,i,s,n,a,o,l,u=1;do{for(r=e,e=null,n=null,a=0;r;){for(a++,i=r,o=0,t=0;t<u&&(o++,i=i.nextZ);t++);for(l=u;o>0||l>0&&i;)0!==o&&(0===l||!i||r.z<=i.z)?(s=r,r=r.nextZ,o--):(s=i,i=i.nextZ,l--),n?n.nextZ=s:e=s,s.prevZ=n,n=s;r=i}n.nextZ=null,u*=2}while(a>1)}(s)}function p(e,t,r,i,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*s)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*s)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function f(e){var t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function x(e,t,r,i,s,n,a,o){return(s-a)*(t-o)-(e-a)*(n-o)>=0&&(e-a)*(i-o)-(r-a)*(t-o)>=0&&(r-a)*(n-o)-(s-a)*(i-o)>=0}function y(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&m(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}(e,t)&&(b(e,t)&&b(t,e)&&function(e,t){var r=e,i=!1,s=(e.x+t.x)/2,n=(e.y+t.y)/2;do{r.y>n!=r.next.y>n&&r.next.y!==r.y&&s<(r.next.x-r.x)*(n-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==e);return i}(e,t)&&(g(e.prev,e,t.prev)||g(e,t.prev,t))||S(e,t)&&g(e.prev,e,e.next)>0&&g(t.prev,t,t.next)>0)}function g(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function S(e,t){return e.x===t.x&&e.y===t.y}function m(e,t,r,i){var s=V(g(e,t,r)),n=V(g(e,t,i)),a=V(g(r,i,e)),o=V(g(r,i,t));return s!==n&&a!==o||!(0!==s||!_(e,r,t))||!(0!==n||!_(e,i,t))||!(0!==a||!_(r,e,i))||!(0!==o||!_(r,t,i))}function _(e,t,r){return t.x<=Math.max(e.x,r.x)&&t.x>=Math.min(e.x,r.x)&&t.y<=Math.max(e.y,r.y)&&t.y>=Math.min(e.y,r.y)}function V(e){return e>0?1:e<0?-1:0}function b(e,t){return g(e.prev,e,e.next)<0?g(e,t,e.next)>=0&&g(e,e.prev,t)>=0:g(e,t,e.prev)<0||g(e,e.next,t)<0}function M(e,t){var r=new T(e.i,e.x,e.y),i=new T(t.i,t.x,t.y),s=e.next,n=t.prev;return e.next=t,t.prev=e,r.next=s,s.prev=r,i.next=r,r.prev=i,n.next=i,i.prev=n,i}function L(e,t,r,i){var s=new T(e,t,r);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}function z(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function T(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function w(e,t,r,i){for(var s=0,n=t,a=r-i;n<r;n+=i)s+=(e[a]-e[n])*(e[n+1]+e[a+1]),a=n;return s}return e.deviation=function(e,t,r,i){var s=t&&t.length,n=s?t[0]*r:e.length,a=Math.abs(w(e,0,n,r));if(s)for(var o=0,l=t.length;o<l;o++){var u=t[o]*r,h=o<l-1?t[o+1]*r:e.length;a-=Math.abs(w(e,u,h,r))}var c=0;for(o=0;o<i.length;o+=3){var v=i[o]*r,d=i[o+1]*r,p=i[o+2]*r;c+=Math.abs((e[v]-e[p])*(e[d+1]-e[v+1])-(e[v]-e[d])*(e[p+1]-e[v+1]))}return 0===a&&0===c?0:Math.abs((c-a)/a)},e.flatten=function(e){for(var t=e[0][0].length,r={vertices:[],holes:[],dimensions:t},i=0,s=0;s<e.length;s++){for(var n=0;n<e[s].length;n++)for(var a=0;a<t;a++)r.vertices.push(e[s][n][a]);s>0&&(i+=e[s-1].length,r.holes.push(i))}return r},e},void 0!==(n=s())&&(i.exports=n);const o=a.exports},71200:(e,t,r)=>{r.d(t,{vX:()=>u,s5:()=>o,k3:()=>l,Or:()=>a}),Number.POSITIVE_INFINITY;const i=128/Math.PI,s=1/Math.LN2;function n(e,t){return(e%=t)>=0?e:e+t}function a(e){return n(e*i,256)}function o(e){return n(.7111111111111111*e,256)}function l(e){return Math.log(e)*s}function u(e,t,r){return e>=t&&e<=r||e>=r&&e<=t}},89106:(e,t,r)=>{r.d(t,{dk:()=>d,Gq:()=>y,a:()=>f,mE:()=>p,m2:()=>l,qr:()=>x,jj:()=>a,hF:()=>o});var i=r(70375),s=r(38716),n=r(65956);function a(e,t){switch(e){case s.LW.FILL:return d.from(t);case s.LW.LINE:return f.from(t);case s.LW.MARKER:return p.from(t);case s.LW.TEXT:return x.from(t);case s.LW.LABEL:return y.from(t);default:throw new Error(`Unable to createMaterialKey for unknown geometryType ${e}`)}}function o(e){switch(l.load(e).geometryType){case s.LW.MARKER:return new p(e);case s.LW.FILL:return new d(e);case s.LW.LINE:return new f(e);case s.LW.TEXT:return new x(e);case s.LW.LABEL:return new y(e)}}class l{constructor(e){this._data=0,this._data=e}static load(e){const t=this.shared;return t.data=e,t}set data(e){this._data=e}get data(){return this._data}get geometryType(){return this.bits(8,11)}set geometryType(e){this.setBits(e,8,11)}get mapAligned(){return!!this.bit(20)}set mapAligned(e){this.setBit(20,e)}get sdf(){return!!this.bit(11)}set sdf(e){this.setBit(11,e)}get pattern(){return!!this.bit(12)}set pattern(e){this.setBit(12,e)}get textureBinding(){return this.bits(0,8)}set textureBinding(e){this.setBits(e,0,8)}get geometryTypeString(){switch(this.geometryType){case s.LW.FILL:return"fill";case s.LW.MARKER:return"marker";case s.LW.LINE:return"line";case s.LW.TEXT:return"text";case s.LW.LABEL:return"label";default:throw new i.Z(`Unable to handle unknown geometryType: ${this.geometryType}`)}}setBit(e,t){const r=1<<e;t?this._data|=r:this._data&=~r}bit(e){return(this._data&1<<e)>>e}setBits(e,t,r){for(let i=t,s=0;i<r;i++,s++)this.setBit(i,0!=(e&1<<s))}bits(e,t){let r=0;for(let i=e,s=0;i<t;i++,s++)r|=this.bit(i)<<s;return r}hasVV(){return!1}setVV(e,t){}getVariation(){return{mapAligned:this.mapAligned,pattern:this.pattern,sdf:this.sdf}}getVariationHash(){return this._data&~(7&this.textureBinding)}}l.shared=new l(0);const u=e=>class extends e{get vvSizeMinMaxValue(){return 0!==this.bit(16)}set vvSizeMinMaxValue(e){this.setBit(16,e)}get vvSizeScaleStops(){return 0!==this.bit(17)}set vvSizeScaleStops(e){this.setBit(17,e)}get vvSizeFieldStops(){return 0!==this.bit(18)}set vvSizeFieldStops(e){this.setBit(18,e)}get vvSizeUnitValue(){return 0!==this.bit(19)}set vvSizeUnitValue(e){this.setBit(19,e)}hasVV(){return super.hasVV()||this.vvSizeMinMaxValue||this.vvSizeScaleStops||this.vvSizeFieldStops||this.vvSizeUnitValue}setVV(e,t){super.setVV(e,t);const r=function(e,t){const r=s.X.SIZE_FIELD_STOPS|s.X.SIZE_MINMAX_VALUE|s.X.SIZE_SCALE_STOPS|s.X.SIZE_UNIT_VALUE,i=(e&(s.mf.FIELD_TARGETS_OUTLINE|s.mf.MINMAX_TARGETS_OUTLINE|s.mf.SCALE_TARGETS_OUTLINE|s.mf.UNIT_TARGETS_OUTLINE))>>>4;return t.isOutline||t.isOutlinedFill?r&i:r&~i}(e,t)&e;this.vvSizeMinMaxValue=!!(r&s.X.SIZE_MINMAX_VALUE),this.vvSizeFieldStops=!!(r&s.X.SIZE_FIELD_STOPS),this.vvSizeUnitValue=!!(r&s.X.SIZE_UNIT_VALUE),this.vvSizeScaleStops=!!(r&s.X.SIZE_SCALE_STOPS)}},h=e=>class extends e{get vvRotation(){return 0!==this.bit(15)}set vvRotation(e){this.setBit(15,e)}hasVV(){return super.hasVV()||this.vvRotation}setVV(e,t){super.setVV(e,t),this.vvRotation=!t.isOutline&&!!(e&s.X.ROTATION)}},c=e=>class extends e{get vvColor(){return 0!==this.bit(13)}set vvColor(e){this.setBit(13,e)}hasVV(){return super.hasVV()||this.vvColor}setVV(e,t){super.setVV(e,t),this.vvColor=!t.isOutline&&!!(e&s.X.COLOR)}},v=e=>class extends e{get vvOpacity(){return 0!==this.bit(14)}set vvOpacity(e){this.setBit(14,e)}hasVV(){return super.hasVV()||this.vvOpacity}setVV(e,t){super.setVV(e,t),this.vvOpacity=!t.isOutline&&!!(e&s.X.OPACITY)}};class d extends(c(v(u(l)))){static load(e){const t=this.shared;return t.data=e,t}static from(e){const t=this.load(0);return t.geometryType=s.LW.FILL,t.dotDensity="dot-density"===e.stride.fill,t.simple="simple"===e.stride.fill,t.outlinedFill=e.isOutlinedFill,t.dotDensity||t.setVV(e.vvFlags,e),t.data}getVariation(){return{...super.getVariation(),dotDensity:this.dotDensity,outlinedFill:this.outlinedFill,simple:this.simple,vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}get dotDensity(){return!!this.bit(15)}set dotDensity(e){this.setBit(15,e)}get simple(){return!!this.bit(22)}set simple(e){this.setBit(22,e)}get outlinedFill(){return!!this.bit(21)}set outlinedFill(e){this.setBit(21,e)}}d.shared=new d(0);class p extends(c(v(h(u(l))))){static load(e){const t=this.shared;return t.data=e,t}static from(e){const t=this.load(0);return t.geometryType=s.LW.MARKER,t.setVV(e.vvFlags,e),t.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvRotation:this.vvRotation,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}p.shared=new p(0);class f extends(c(v(u(l)))){static load(e){const t=this.shared;return t.data=e,t}static from(e){const t=this.load(0);return t.geometryType=s.LW.LINE,t.setVV(e.vvFlags,e),t.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}f.shared=new f(0);class x extends(c(v(h(u(l))))){static load(e){const t=this.shared;return t.data=e,t}static from(e){const t=this.load(0);return t.geometryType=s.LW.TEXT,t.setVV(e.vvFlags,e),t.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvRotation:this.vvRotation,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}x.shared=new x(0);class y extends(u(l)){static load(e){const t=this.shared;return t.data=e,t}static from(e){const t=this.load(0);return t.geometryType=s.LW.LABEL,t.setVV(e.vvFlags,e),t.mapAligned=(0,n.N)(e.placement),t.data}getVariation(){return{...super.getVariation(),vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}y.shared=new y(0)},65956:(e,t,r)=>{function i(e){switch(e){case"above-along":case"below-along":case"center-along":case"esriServerLinePlacementAboveAlong":case"esriServerLinePlacementBelowAlong":case"esriServerLinePlacementCenterAlong":return!0;default:return!1}}r.d(t,{N:()=>i})},67766:(e,t,r)=>{r.d(t,{Z:()=>l});var i=r(36663),s=r(53280),n=r(81977),a=(r(7753),r(39994),r(7283),r(40266));let o=class extends s.r{initialize(){}destroy(){}get supportsTileUpdates(){return!1}get spatialReference(){const e=this.get("tileStore.tileScheme.spatialReference");return e&&e.toJSON()||null}};(0,i._)([(0,n.Cb)({readOnly:!0})],o.prototype,"supportsTileUpdates",null),(0,i._)([(0,n.Cb)({constructOnly:!0})],o.prototype,"remoteClient",void 0),(0,i._)([(0,n.Cb)({constructOnly:!0})],o.prototype,"service",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"spatialReference",null),(0,i._)([(0,n.Cb)({constructOnly:!0})],o.prototype,"tileInfo",void 0),(0,i._)([(0,n.Cb)({constructOnly:!0})],o.prototype,"tileStore",void 0),o=(0,i._)([(0,a.j)("esri.views.2d.layers.features.processors.BaseProcessor")],o);const l=o},84899:(e,t,r)=>{r.r(t),r.d(t,{default:()=>b});var i=r(36663),s=r(89060),n=(r(70375),r(39994)),a=r(13802),o=r(61681),l=r(78668),u=(r(7283),r(7753),r(33156),r(40266)),h=r(27281),c=r(14685),v=r(88013),d=r(88710),p=r(13191),f=r(12044),x=r(41808),y=r(40576),g=r(67766);class S{constructor(e){this._remoteClient=e,this._resourceMap=new Map,this._inFlightResourceMap=new Map}destroy(){}async fetchResource(e,t){const r=this._resourceMap,i=r.get(e);if(i)return i;let s=this._inFlightResourceMap.get(e);if(s)return s;try{s=this._remoteClient.invoke("tileRenderer.fetchResource",{url:e},{...t}),this._inFlightResourceMap.set(e,s),s.then((t=>(this._inFlightResourceMap.delete(e),r.set(e,t),t)))}catch(e){return(0,l.D_)(e)?null:{width:0,height:0}}return s}getResource(e){var t;return null!=(t=this._resourceMap.get(e))?t:null}}function m(e,t){return(!e.minScale||e.minScale>=t)&&(!e.maxScale||e.maxScale<=t)}function _(e){const t=e.message,r={message:{data:{},tileKey:t.tileKey,tileKeyOrigin:t.tileKeyOrigin},transferList:new Array};for(const e in t.data){const i=t.data[e];if(r.message.data[e]=null,(0,o.pC)(i)){const t=i.stride,s=i.indices.slice(0),n=i.vertices.slice(0),a=i.records.slice(0),l={stride:t,indices:s,vertices:n,records:a,metrics:(0,o.Po)(i.metrics,(e=>e.slice(0)))};r.transferList.push(s,n,a),r.message.data[e]=l}}return r}a.Z.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor");let V=class extends g.Z{constructor(){super(...arguments),this.type="symbol",this._matchers={feature:null,aggregate:null},this._bufferData=new Map,this._bufferIds=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))]),this._resourceManagerProxy=new S(this.remoteClient)}destroy(){this._resourceManagerProxy.destroy()}get supportsTileUpdates(){return!0}forEachBufferId(e){this._bufferIds.forEach((t=>{t.forEach(e)}))}async update(e,t){const r=t.schema.processors[0];if("symbol"!==r.type)return;const i=(0,h.Hg)(this._schema,r);(0,h.uD)(i,"mesh")&&((0,n.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Processor:",i),e.mesh=!0,e.why.mesh.push("Symbology changed"),this._schema=r,this._factory=this._createFactory(r),this._factory.update(r,this.tileStore.tileScheme.tileInfo))}onTileMessage(e,t,r,i){return(0,l.k_)(i),this._onTileData(e,t,r,i)}onTileClear(e){return this._bufferData.delete(e.key.id),this._bufferIds.delete(e.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:{clear:!0}})}onTileError(e,t,r){const i=r.signal,s={tileKey:e.id,error:t};return this.remoteClient.invoke("tileRenderer.onTileError",s,{signal:i})}onTileUpdate(e){for(const t of e.removed)this._bufferData.has(t.key.id)&&this._bufferData.delete(t.key.id),this._bufferIds.has(t.key.id)&&this._bufferIds.delete(t.key.id);for(const t of e.added)this._bufferData.forEach((e=>{for(const r of e)r.message.tileKey===t.id&&this._updateTileMesh("append",t,_(r),[],!1,!1,null)}))}_addBufferData(e,t){this._bufferData.has(e)||this._bufferData.set(e,[]),this._bufferData.get(e).push(_(t))}_createFactory(e){const{geometryType:t,objectIdField:r,fields:i}=this.service,s={geometryType:t,fields:i,spatialReference:c.Z.fromJSON(this.spatialReference)},n=new f.Wr(((e,t)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",e,t)),this.tileStore.tileScheme.tileInfo),{matcher:a,aggregateMatcher:l}=e.mesh;return this._store=n,this._matchers.feature=(0,x.fL)(a,n,s,this._resourceManagerProxy),this._matchers.aggregate=(0,o.Po)(l,(e=>(0,x.fL)(e,n,s,this._resourceManagerProxy))),new p.j(t,r,n)}async _onTileData(e,t,r,i){(0,l.k_)(i);const{type:s,addOrUpdate:n,remove:a}=t,u=t.end,h=!!this._schema.mesh.sortKey;if(!n){const t={type:s,addOrUpdate:null,remove:a,clear:!1,end:u,sort:h};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:t},i)}const c=this._processFeatures(e,n,r,i);try{const r=await c;if((0,o.Wi)(r)){const t={type:s,addOrUpdate:null,remove:a,clear:!1,end:u,sort:h};return this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:t},i)}const n=[];for(const t of r){let r=!1;const i=t.message.bufferIds,s=e.key.id,a=t.message.tileKey;if(s!==a&&(0,o.pC)(i)){if(!this.tileStore.get(a)){this._addBufferData(s,t),n.push(t);continue}let e=this._bufferIds.get(a);e||(e=new Set,this._bufferIds.set(a,e));const o=Array.from(i);for(const t of o){if(e.has(t)){r=!0;break}e.add(t)}}r||(this._addBufferData(s,t),n.push(t))}await(0,l.$6)(n.map((r=>{const n=e.key.id===r.message.tileKey,a=n?t.remove:[],o=n&&t.end;return this._updateTileMesh(s,e,r,a,o,t.clear,i.signal)})))}catch(t){this._handleError(e,t,i)}}async _updateTileMesh(e,t,r,i,s,n,a){const u=e,h=r.message.tileKey,c=!!this._schema.mesh.sortKey;h!==t.key.id&&(s=!1);const v=(0,o.Po)(r,(e=>e.message)),d=(0,o.Po)(r,(e=>e.transferList))||[],p={type:u,addOrUpdate:v,remove:i,clear:!1,end:s,sort:c},f={transferList:(0,o.Wg)(d)||[],signal:a};return(0,l.k_)(f),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:h,data:p},f)}async _processFeatures(e,t,r,i){if((0,o.Wi)(t)||!t.hasFeatures)return null;const s={transform:e.transform,hasZ:!1,hasM:!1},n=this._factory,a={viewingMode:"",scale:e.scale},u=await this._matchers.feature,h=await this._matchers.aggregate;(0,l.k_)(i);const c=this._getLabelInfos(e,t);return await n.analyze(t.getCursor(),this._resourceManagerProxy,u,h,s,a),(0,l.k_)(i),this._writeFeatureSet(e,t,s,c,n,r)}_writeFeatureSet(e,t,r,i,s,n){const a=t.getSize(),l=new d._(e.key.id,{features:a,records:a,metrics:0},this._schema.mesh.matcher.stride,n,!0),u={viewingMode:"",scale:e.scale},h=t.getCursor();for(;h.next();)try{const t=h.getDisplayId(),n=(0,o.pC)(i)?i.get(t):null;s.writeCursor(l,h,r,u,e.level,n)}catch(e){}const c=e.tileInfoView.tileInfo.isWrappable;return l.serialize(c)}_handleError(e,t,r){if(!(0,l.D_)(t)){const i={tileKey:e.id,error:t.message};return this.remoteClient.invoke("tileRenderer.onTileError",i,{signal:r.signal})}}_getLabelingSchemaForScale(e){const t=this._schema.mesh.labels;if((0,o.Wi)(t))return null;if("subtype"===t.type){const r={type:"subtype",classes:{}};let i=!1;for(const s in t.classes){const n=t.classes[s].filter((t=>m(t,e.scale)));i=i||!!n.length,r.classes[s]=n}return i?r:null}const r=t.classes.filter((t=>m(t,e.scale)));return r.length?{type:"simple",classes:r}:null}_getLabels(e,t){if("subtype"===t.type){var r;const i=this.service.subtypeField,s=(0,o.s3)(i,"Expected to find subtype Field"),n=e.readAttribute(s);return null==n?[]:null!=(r=t.classes[n])?r:[]}return t.classes}_getLabelInfos(e,t){const r=this._getLabelingSchemaForScale(e);if((0,o.Wi)(r))return null;const i=new Map,n=t.getCursor();for(;n.next();){const e=n.getDisplayId(),t=[],a=(0,v.nE)(e),o=a&&1!==n.readAttribute("cluster_count")?"aggregate":"feature",l=this._getLabels(n,r);for(const r of l){if(r.target!==o)continue;const i=n.getStorage(),l=a&&"feature"===o?i.getComputedStringAtIndex(n.readAttribute("referenceId"),r.fieldIndex):i.getComputedStringAtIndex(e,r.fieldIndex);if(!l)continue;const u=(0,s.E)(l.toString()),h=u[0],c=u[1];this._store.getMosaicItem(r.symbol,(0,y._)(h)).then((e=>{t[r.index]={glyphs:e.glyphMosaicItems,rtl:c,index:r.index}}))}i.set(e,t)}return i}};V=(0,i._)([(0,u.j)("esri.views.2d.layers.features.processors.SymbolProcessor")],V);const b=V}}]);
//# sourceMappingURL=6290.js.map